name: Akismet Discussion Comment Checker (GraphQL)

on:
  discussion_comment:
    types: [created]

permissions:
  discussions: write

jobs:
  check-akismet:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€æŸ¥å¹¶åˆ é™¤åƒåœ¾è¯„è®º
        env:
          AKISMET_API_KEY: ${{ secrets.AKISMET_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
          COMMENT_NODE_ID: ${{ github.event.comment.node_id }}
          COMMENT_HTML_URL: ${{ github.event.comment.html_url }}
          DISCUSSION_TITLE: ${{ github.event.discussion.title }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          set -euo pipefail
          
          echo "============================================"
          echo "ğŸ¤– å¼€å§‹ AKISMET åƒåœ¾è¯„è®ºæ£€æµ‹ (GraphQL)"
          echo "============================================"
          echo "â° æ£€æµ‹æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ‘¤ è¯„è®ºä½œè€…: ${COMMENT_AUTHOR}"
          echo "ğŸ“ è¯„è®ºé•¿åº¦: ${#COMMENT_BODY} ä¸ªå­—ç¬¦"
          echo "ğŸ—‚ï¸ ä»“åº“åç§°: ${REPO_OWNER}/${REPO_NAME}"
          echo "ğŸ’¬ è®¨è®ºæ ‡é¢˜: ${DISCUSSION_TITLE}"
          echo "ğŸ”— è¯„è®ºé“¾æ¥: ${COMMENT_HTML_URL}"
          echo "ğŸ†” Comment Node ID: ${COMMENT_NODE_ID}"
          echo ""
          
          echo "ğŸ“„ è¯„è®ºå†…å®¹:"
          echo "----------------------------------------"
          echo "${COMMENT_BODY}"
          echo "----------------------------------------"
          echo ""
          
          echo "ğŸŒ AKISMET API è¯·æ±‚ä¿¡æ¯:"
          AKISMET_URL="https://${AKISMET_API_KEY}.rest.akismet.com/1.1/comment-check"
          echo "ğŸ“¡ API æ¥å£: ${AKISMET_URL:0:30}...comment-check"
          echo "ğŸ  åšå®¢åœ°å€: https://github.com/${REPO_OWNER}/${REPO_NAME}"
          echo ""
          
          echo "ğŸ”„ æ­£åœ¨å‘é€è¯·æ±‚åˆ° Akismet..."
          AKISMET_RESPONSE=$(curl -sS -w "\nHTTP_CODE:%{http_code}\nTOTAL_TIME:%{time_total}" \
            -X POST "$AKISMET_URL" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -H "User-Agent: GitHubActionBot/1.0" \
            --data-urlencode "blog=https://github.com/${REPO_OWNER}/${REPO_NAME}" \
            --data-urlencode "user_ip=127.0.0.1" \
            --data-urlencode "user_agent=GitHubActionBot/1.0" \
            --data-urlencode "comment_type=comment" \
            --data-urlencode "comment_author=${COMMENT_AUTHOR}" \
            --data-urlencode "comment_content=${COMMENT_BODY}")
          
          SPAM_CHECK_RESULT=$(echo "$AKISMET_RESPONSE" | head -n1)
          HTTP_CODE=$(echo "$AKISMET_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          RESPONSE_TIME=$(echo "$AKISMET_RESPONSE" | grep "TOTAL_TIME:" | cut -d: -f2)
          
          echo "ğŸ“Š AKISMET å“åº”ç»“æœ:"
          echo "ğŸ“ˆ HTTP çŠ¶æ€ç : ${HTTP_CODE:-æœªçŸ¥}"
          echo "â±ï¸ å“åº”æ—¶é—´: ${RESPONSE_TIME:-æœªçŸ¥}ç§’"
          echo "ğŸ¯ åƒåœ¾è¯„è®ºæ£€æµ‹ç»“æœ: '${SPAM_CHECK_RESULT}'"
          echo ""
          
          if [ "$SPAM_CHECK_RESULT" = "true" ]; then
            echo "ğŸš¨ æ£€æµ‹åˆ°åƒåœ¾è¯„è®º!"
            echo "============================================"
            echo "ğŸ—‘ï¸ æ­£åœ¨ä½¿ç”¨ GraphQL API åˆ é™¤åƒåœ¾è¯„è®º..."
            echo ""
            
            echo "ğŸ” GitHub GraphQL API åˆ é™¤è¯·æ±‚:"
            echo "ğŸ“¡ API æ¥å£: https://api.github.com/graphql"
            echo "ğŸ†” Comment Node ID: ${COMMENT_NODE_ID}"
            echo "ğŸ”‘ è®¤è¯ä»¤ç‰Œ: token ${GITHUB_TOKEN:0:8}..."
            echo ""

            # ç”¨ jq æ„é€  JSONï¼Œé¿å…å­—ç¬¦ä¸²æ‹¼æ¥æŠŠ JSON æå
            GRAPHQL_PAYLOAD=$(jq -n --arg cid "$COMMENT_NODE_ID" '
              {
                query: "mutation DeleteDiscussionComment($commentId: ID!) { deleteDiscussionComment(input: { id: $commentId }) { clientMutationId } }",
                variables: { commentId: $cid }
              }'
            )

            echo "ğŸ”„ æ­£åœ¨å‘é€ GraphQL åˆ é™¤è¯·æ±‚..."
            DELETE_RESPONSE=$(curl -sS -w "\nHTTP_CODE:%{http_code}\nTOTAL_TIME:%{time_total}" \
              -X POST "https://api.github.com/graphql" \
              -H "Authorization: Bearer ${GITHUB_TOKEN}" \
              -H "User-Agent: akismet-giscus-bot" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              -H "Content-Type: application/json" \
              -d "$GRAPHQL_PAYLOAD")
            
            DELETE_HTTP_CODE=$(echo "$DELETE_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2 || true)
            DELETE_TIME=$(echo "$DELETE_RESPONSE" | grep "TOTAL_TIME:" | cut -d: -f2 || true)
            DELETE_BODY=$(echo "$DELETE_RESPONSE" | sed '$d' | sed '$d')
            
            echo "ğŸ“Š åˆ é™¤è¯·æ±‚å“åº”:"
            echo "ğŸ“ˆ HTTP çŠ¶æ€ç : ${DELETE_HTTP_CODE:-æœªçŸ¥}"
            echo "â±ï¸ å“åº”æ—¶é—´: ${DELETE_TIME:-æœªçŸ¥}ç§’"
            echo "ğŸ“„ å“åº”å†…å®¹: ${DELETE_BODY}"
            echo ""
            
            if [ "$DELETE_HTTP_CODE" = "200" ]; then
              if echo "$DELETE_BODY" | grep -q '"errors"'; then
                echo "âŒ GraphQL é”™è¯¯: åˆ é™¤å¤±è´¥"
                echo "ğŸ” é”™è¯¯è¯¦æƒ…:"
                echo "$DELETE_BODY" | jq '.errors' || echo "$DELETE_BODY"
                
                if echo "$DELETE_BODY" | grep -q "Resource not accessible"; then
                  echo "âš ï¸ èµ„æºä¸å¯è®¿é—® - å¤§æ¦‚ç‡æ˜¯æƒé™é—®é¢˜ï¼ˆtoken / permissionsï¼‰"
                elif echo "$DELETE_BODY" | grep -q "Could not resolve to a node"; then
                  echo "âš ï¸ æ— æ³•è§£æèŠ‚ç‚¹ID - Node ID å¯èƒ½ä¸å¯¹æˆ–å¯¹è±¡å·²ä¸å­˜åœ¨"
                else
                  echo "âš ï¸ å…¶ä»– GraphQL é”™è¯¯"
                fi
                exit 1
              else
                echo "âœ… æˆåŠŸ: åƒåœ¾è¯„è®ºå·²æˆåŠŸåˆ é™¤"
                echo "ğŸ‰ æ¥è‡ª @${COMMENT_AUTHOR} çš„è¯„è®ºå·²è¢«ç§»é™¤"
              fi
            else
              echo "âŒ å¤±è´¥: HTTP è¯·æ±‚å¤±è´¥"
              exit 1
            fi
            
          elif [ "$SPAM_CHECK_RESULT" = "false" ]; then
            echo "âœ… æ­£å¸¸è¯„è®º"
            echo "============================================"
            echo "ğŸŸ¢ Akismet åˆ¤å®šè¿™ä¸æ˜¯åƒåœ¾è¯„è®º"
            echo "âœ¨ æ¥è‡ª @${COMMENT_AUTHOR} çš„è¯„è®ºè¢«å…è®¸"
          else
            echo "âš ï¸ AKISMET é”™è¯¯"
            echo "============================================"
            echo "âŒ Akismet API è¿”å›æ„å¤–å“åº”"
            echo "ğŸ“„ åŸå§‹å“åº”: '${SPAM_CHECK_RESULT}'"
            echo "ğŸ“ˆ HTTP çŠ¶æ€ç : ${HTTP_CODE:-æœªçŸ¥}"
            if [ "${HTTP_CODE:-}" != "200" ]; then
              echo "ğŸ” è¿™å¯èƒ½è¡¨ç¤º API å¯†é’¥é—®é¢˜æˆ–æœåŠ¡æ•…éšœ"
              exit 1
            fi
          fi
          
          echo ""
          echo "============================================"
          echo "ğŸ AKISMET åƒåœ¾è¯„è®ºæ£€æµ‹å®Œæˆ"
          echo "â° ç»“æŸæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "============================================"
