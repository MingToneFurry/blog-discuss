name: Akismet Discussion Comment Checker (GraphQL)

on:
  discussion_comment:
    types: [created]

# 这行对使用内置 GITHUB_TOKEN 很重要；即使用 PAT 也不冲突
permissions:
  discussions: write

jobs:
  check-akismet:
    runs-on: ubuntu-latest
    steps:
      - name: 检查并删除垃圾评论（Akismet + GitHub GraphQL）
        env:
          AKISMET_API_KEY: ${{ secrets.AKISMET_API_KEY }}

          # 建议用你自己的 PAT（secrets.GH_TOKEN），gh cli 默认读 GH_TOKEN
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
          COMMENT_NODE_ID: ${{ github.event.comment.node_id }}
          COMMENT_HTML_URL: ${{ github.event.comment.html_url }}
          DISCUSSION_TITLE: ${{ github.event.discussion.title }}

          # 直接用 GitHub Actions 自带的仓库信息
          REPO_FULL: ${{ github.repository }}
        shell: bash
        run: |
          set -euo pipefail

          echo "============================================"
          echo "🤖 开始 AKISMET 垃圾评论检测 (GraphQL)"
          echo "============================================"
          echo "⏰ 检测时间: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "👤 评论作者: ${COMMENT_AUTHOR}"
          echo "📝 评论长度: ${#COMMENT_BODY} 个字符"
          echo "🗂️ 仓库名称: ${REPO_FULL}"
          echo "💬 讨论标题: ${DISCUSSION_TITLE}"
          echo "🔗 评论链接: ${COMMENT_HTML_URL}"
          echo "🆔 Comment Node ID: ${COMMENT_NODE_ID}"
          echo ""

          echo "📄 评论内容:"
          echo "----------------------------------------"
          printf '%s\n' "${COMMENT_BODY}"
          echo "----------------------------------------"
          echo ""

          # 1) Akismet 检测
          echo "🌐 AKISMET API 请求信息:"
          AKISMET_URL="https://${AKISMET_API_KEY}.rest.akismet.com/1.1/comment-check"
          echo "📡 API 接口: ${AKISMET_URL:0:30}...comment-check"
          echo "🏠 博客地址: https://github.com/${REPO_FULL}"
          echo ""

          echo "🔄 正在发送请求到 Akismet..."
          AKISMET_RESPONSE="$(curl --http1.1 -sS -w "\nHTTP_CODE:%{http_code}\nTOTAL_TIME:%{time_total}" \
            -X POST "${AKISMET_URL}" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -A "GitHubActionBot/1.0" \
            --data-urlencode "blog=https://github.com/${REPO_FULL}" \
            --data-urlencode "user_ip=127.0.0.1" \
            --data-urlencode "user_agent=GitHubActionBot/1.0" \
            --data-urlencode "comment_type=comment" \
            --data-urlencode "comment_author=${COMMENT_AUTHOR}" \
            --data-urlencode "comment_content=${COMMENT_BODY}" \
          )"

          SPAM_CHECK_RESULT="$(echo "${AKISMET_RESPONSE}" | head -n1)"
          HTTP_CODE="$(echo "${AKISMET_RESPONSE}" | grep -E "HTTP_CODE:" | cut -d: -f2 || true)"
          RESPONSE_TIME="$(echo "${AKISMET_RESPONSE}" | grep -E "TOTAL_TIME:" | cut -d: -f2 || true)"

          echo "📊 AKISMET 响应结果:"
          echo "📈 HTTP 状态码: ${HTTP_CODE:-未知}"
          echo "⏱️ 响应时间: ${RESPONSE_TIME:-未知}秒"
          echo "🎯 垃圾评论检测结果: '${SPAM_CHECK_RESULT}'"
          echo ""

          if [[ "${HTTP_CODE:-}" != "200" ]]; then
            echo "⚠️ AKISMET 错误：HTTP 非 200"
            echo "📄 原始响应(首行): '${SPAM_CHECK_RESULT}'"
            exit 1
          fi

          # 2) 如果是垃圾评论：用 gh api graphql 删除 Discussion Comment
          if [[ "${SPAM_CHECK_RESULT}" == "true" ]]; then
            echo "🚨 检测到垃圾评论!"
            echo "============================================"
            echo "🗑️ 正在使用 GraphQL API 删除垃圾评论..."
            echo ""
            echo "🔍 GitHub GraphQL API 删除请求:"
            echo "📡 API 接口: https://api.github.com/graphql"
            echo "🆔 Comment Node ID: ${COMMENT_NODE_ID}"
            echo "🔑 认证令牌: token ${GH_TOKEN:0:8}..."
            echo ""

            # gh api graphql 最稳，不容易被 curl/JSON/换行坑到
            GRAPHQL_QUERY='mutation DeleteDiscussionComment($commentId: ID!) { deleteDiscussionComment(input: { id: $commentId }) { clientMutationId } }'

            echo "🔄 正在发送 GraphQL 删除请求..."
            DELETE_BODY="$(gh api graphql \
              -f query="${GRAPHQL_QUERY}" \
              -f commentId="${COMMENT_NODE_ID}" \
              --jq '.' \
            )"

            echo "📊 删除请求响应:"
            echo "📄 响应内容: ${DELETE_BODY}"
            echo ""

            # 检查 GraphQL errors
            if echo "${DELETE_BODY}" | jq -e '.errors? | length > 0' >/dev/null 2>&1; then
              echo "❌ GraphQL 错误: 删除失败"
              echo "🔍 错误详情:"
              echo "${DELETE_BODY}" | jq '.errors' || true
              exit 1
            fi

            echo "✅ 成功: 垃圾评论已成功删除"
            echo "🎉 来自 @${COMMENT_AUTHOR} 的评论已被移除"

          elif [[ "${SPAM_CHECK_RESULT}" == "false" ]]; then
            echo "✅ 正常评论"
            echo "============================================"
            echo "🟢 Akismet 判定这不是垃圾评论"
            echo "✨ 来自 @${COMMENT_AUTHOR} 的评论被允许"

          else
            echo "⚠️ AKISMET 返回意外响应"
            echo "📄 原始响应(首行): '${SPAM_CHECK_RESULT}'"
            exit 1
          fi

          echo ""
          echo "============================================"
          echo "🏁 AKISMET 垃圾评论检测完成"
          echo "⏰ 结束时间: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "============================================"
